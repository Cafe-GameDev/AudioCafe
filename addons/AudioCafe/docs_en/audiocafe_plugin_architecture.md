# AudioCafe Plugin Architecture

This document details the architecture of the AudioCafe plugin, describing its main components and how they interact to provide an optimized workflow for audio management in the Godot Engine.

## Overview

AudioCafe is designed as a modular set of scripts and resources that integrate seamlessly with the Godot editor. It automates the creation of audio resources (`AudioStreamPlaylist`, `AudioStreamRandomizer`, `AudioStreamSynchronized`) from raw audio files and organizes them into a centralized `AudioManifest` for easy runtime access.

## Architectural Components

### 1. User Interaction

Represents the end-user interacting with the plugin through the editor interface.

### 2. Editor Plugin Core

*   **`editor_plugin.gd`**: The main plugin script. It extends `EditorPlugin` and is responsible for initializing the AudioCafe panel UI, managing its lifecycle (entering and exiting the editor tree), and ensuring that `audio_config.tres` is loaded or created.
*   **`editor_export_plugin.gd`**: An export plugin that extends `EditorExportPlugin`. Its function is to ensure that all audio resources generated by AudioCafe are correctly included in the exported builds of your game, preventing missing resource issues.

### 3. Editor UI

*   **`audio_panel.tscn`**: The scene that defines the visual structure of the AudioCafe panel in the editor. It contains all interface elements, such as buttons, input fields, and labels.
*   **`audio_panel.gd`**: The script associated with `audio_panel.tscn`. It controls the user interface logic, such as loading/saving configurations, displaying generation status, showing generated audio, and triggering the manifest generation process.

### 4. Configuration & Manifest Resources

*   **`audio_config.gd`**: A `Resource` script that defines the structure of the plugin's configurations. It contains properties such as `assets_paths`, `dist_path`, and flags for generating different types of `AudioStream`.
*   **`audio_config.tres`**: The persistent instance of `audio_config.gd`. It stores user configurations and is directly editable in the editor.
*   **`audio_manifest.gd`**: A `Resource` script that defines the structure of the audio manifest. It contains dictionaries to store references to `AudioStreamPlaylist`, `AudioStreamRandomizer`, `AudioStreamSynchronized`, and `AudioStreamInteractive`.
*   **`audio_manifest.tres`**: The persistent instance of `audio_manifest.gd`. It is the centralized catalog of all generated or collected audio resources, used for runtime access.

### 5. Audio Generation Logic

*   **`generate_audio_manifest.gd`**: The main script responsible for orchestrating the generation process. It scans asset directories, loads raw `AudioStream`s, creates `.tres` resources (playlists, randomizers, synchronized), and updates `audio_manifest.tres` with references.

### 6. Generated Audio Resources (dist/)

These are the `.tres` files that the plugin creates in the user-configured distribution directory (`dist_path`):

*   **`AudioStreamPlaylist.tres`**: Resources that contain ordered lists of `AudioStream` for sequential playback.
*   **`AudioStreamRandomizer.tres`**: Resources that contain collections of `AudioStream` for random playback.
*   **`AudioStreamSynchronized.tres`**: Resources that allow synchronized playback of multiple `AudioStream`s.
*   **`AudioStreamInteractive.tres`**: Existing `AudioStreamInteractive` resources that are manually created by the user and whose references are collected by the plugin for inclusion in the manifest.

### 7. Core Godot Engine

The main environment where the plugin operates and interacts with native engine functionalities, such as directory access (`DirAccess`), resource loading/saving (`ResourceLoader`, `ResourceSaver`), and plugin management (`EditorPlugin`).

## Operation Flow

### Initialization and Configuration

1.  The user activates the plugin in the Godot Engine.
2.  `editor_plugin.gd` is loaded and instantiates the `audio_panel.tscn` UI.
3.  `audio_panel.gd` loads or creates `audio_config.tres`.
4.  The user configures `assets_paths` and `dist_path` in the `AudioPanel`.
5.  Configurations are saved in `audio_config.tres`.

### Manifest Generation

1.  The user clicks "Generate Playlists" in the `AudioPanel`.
2.  `audio_panel.gd` triggers `generate_audio_manifest.gd`.
3.  `generate_audio_manifest.gd` reads `audio_config.tres` to get the paths.
4.  It scans `assets_paths` for audio files (`.ogg`, `.wav`).
5.  Generates `AudioStreamPlaylist.tres`, `AudioStreamRandomizer.tres`, and `AudioStreamSynchronized.tres` in `dist_path`.
6.  Collects references to existing `AudioStreamInteractive.tres` in `dist_path`.
7.  Updates `audio_manifest.tres` with the paths and UIDs of all generated/collected resources.
8.  `AudioPanel` is notified, reads the updated `audio_manifest.tres`, and displays available audio.

### Runtime Usage

1.  The game code loads `audio_manifest.tres`.
2.  Accesses desired audio resources (e.g., `audio_manifest.playlists["ui_click"]`) to get the `.tres` path.
3.  Loads the `.tres` and uses it with an `AudioStreamPlayer`.

```mermaid
graph TD
    subgraph User Interaction
        U[User]
    end

    subgraph Editor Plugin Core
        EP[editor_plugin.gd]:::script
        EP_UID[editor_plugin.gd.uid]:::uid
        EEC[EditorExportPlugin]:::script
        EEC_UID[editor_export_plugin.gd.uid]:::uid
    end

    subgraph Editor UI
        AP_TSCN[audio_panel.tscn]:::scene
        AP[audio_panel.gd]:::script
        AP_UID[audio_panel.gd.uid]:::uid
    end

    subgraph Configuration & Manifest Resources
        AC[audio_config.gd]:::script
        AC_UID[audio_config.gd.uid]:::uid
        AM[audio_manifest.gd]:::script
        AM_UID[audio_manifest.gd.uid]:::uid
        AC_RES[audio_config.tres]:::resource
        AM_RES[audio_manifest.tres]:::resource
    end

    subgraph Audio Generation Logic
        GAM[generate_audio_manifest.gd]:::script
        GAM_UID[generate_audio_manifest.gd.uid]:::uid
    end

    subgraph Generated Audio Resources (dist/)
        GAR_PL[AudioStreamPlaylist.tres]:::resource
        GAR_R[AudioStreamRandomizer.tres]:::resource
        GAR_S[AudioStreamSynchronized.tres]:::resource
        GAR_I[AudioStreamInteractive.tres]:::resource
    end

    subgraph Core Godot Engine
        GE[Godot Engine]
    end

    style EP fill:#f9f,stroke:#333,stroke-width:2px
    style EEC fill:#f9f,stroke:#333,stroke-width:2px
    style AP fill:#f9f,stroke:#333,stroke-width:2px
    style AC fill:#f9f,stroke:#333,stroke-width:2px
    style AM fill:#f9f,stroke:#333,stroke-width:2px
    style GAM fill:#f9f,stroke:#333,stroke-width:2px

    classDef script fill:#DDEEFF,stroke:#3366CC,stroke-width:1px
    classDef resource fill:#FFF0DD,stroke:#CC9933,stroke-width:1px
    classDef scene fill:#EEFFDD,stroke:#66CC33,stroke-width:1px
    classDef uid fill:#F0F0F0,stroke:#999999,stroke-width:0.5px

    %% Component Descriptions
    EP -- "Main editor plugin. Instantiates the panel UI and manages the plugin's lifecycle."
    EEC -- "Editor export plugin. Ensures audio resources are included in the final build."
    AP_TSCN -- "Defines the visual structure of the editor panel."
    AP -- "Controls the panel UI logic. Loads/saves configurations, displays status, and triggers manifest generation."
    AC -- "Resource that stores plugin configurations (asset paths, distribution path, panel state). Emits 'config_changed' signal when saved."
    AM -- "Resource that stores the final mapping of audio keys to generated resources (Playlists, Randomizers, Synchronized, Interactive)."
    GAM -- "Main script for scanning directories, loading AudioStreams, generating audio resources (.tres), and updating the AudioManifest."
    AC_RES -- "Persistent instance of AudioConfig, editable in the editor."
    AM_RES -- "Persistent instance of AudioManifest, updated by the plugin."
    GAR_PL -- "Dynamically generated resources that contain lists of AudioStream for sequential playback."
    GAR_R -- "Dynamically generated resources that contain AudioStream for random playback."
    GAR_S -- "Dynamically generated resources that contain AudioStream for synchronized playback."
    GAR_I -- "Existing AudioStreamInteractive resources, collected and referenced by the manifest."

    %% Initialization and Configuration Flow
    U -- "Activates the plugin" --> GE
    GE --> EP: Loads plugin.cfg
    EP --> AP_TSCN: Instantiates panel scene
    AP_TSCN --> AP: Loads panel script
    AP --> AC_RES: Loads/Creates AudioConfig.tres
    AC_RES --> AP: Provides configurations
    AP --> U: Displays panel UI

    U -- "Configures asset and dist paths" --> AP
    AP --> AC_RES: Saves configurations (assets_paths, dist_path)
    AC_RES -- "Emits 'config_changed'" --> AP: Updates save feedback

    %% Manifest Generation Flow
    U -- "Clicks 'Generate Playlists'" --> AP
    AP --> GAM: Triggers _run() with audio_config
    GAM --> AC_RES: Reads assets_paths and dist_path
    GAM --> GE: Scans directories (DirAccess.open, DirAccess.list_dir_begin)
    GE --> GAM: Returns audio files (.ogg, .wav)

    GAM --> GAR_PL: Generates/Updates AudioStreamPlaylist.tres
    GAM --> GAR_R: Generates/Updates AudioStreamRandomizer.tres (if applicable)
    GAM --> GAR_S: Generates/Updates AudioStreamSynchronized.tres (if applicable)
    GAM --> GAR_I: Collects references to existing AudioStreamInteractive
    GAM --> AM_RES: Updates AudioManifest.tres with paths and UIDs of generated resources
    GAM -- "Emits 'generation_finished'" --> AP: Notifies about generation result

    AP --> AM_RES: Reads updated AudioManifest.tres
    AM_RES --> AP: Provides lists of playlists/randomizers/synchronized
    AP --> U: Displays updated lists in the panel

    %% Runtime Usage Flow
    U -- "Accesses audio via code" --> AM_RES: E.g., AudioManifest.playlists.ui_click
    AM_RES --> GE: Provides resource path/UID
    GE --> GAR_PL: Loads AudioStreamPlaylist.tres
    GAR_PL --> U: Audio available for playback

    U -- "Manually creates AudioStreamInteractive" --> GE: Creates .tres in editor
    GE --> GAR_I: Saves AudioStreamInteractive.tres
    GAM -- "Collects existing Interactive" --> GAR_I: GAM includes GAR_I in next generation
    GAR_I --> AM_RES: Referenced in AudioManifest

    %% Other Interactions
    U -- "Clicks 'Docs'" --> AP
    AP --> GE: Opens documentation URL (OS.shell_open)

    %% UIDs
    EP_UID -- "Unique identifier for editor_plugin.gd"
    EEC_UID -- "Unique identifier for editor_export_plugin.gd"
    AP_UID -- "Unique identifier for audio_panel.gd"
    AC_UID -- "Unique identifier for audio_config.gd"
    AM_UID -- "Unique identifier for audio_manifest.gd"
    GAM_UID -- "Unique identifier for generate_audio_manifest.gd"
